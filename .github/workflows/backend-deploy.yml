name: Build and Deploy Backend to Container Apps

on:
    push:
        branches: ["main"]
        paths-ignore:
            - "vaultdrive_client/**"
            - "README.md"
    workflow_dispatch:

env:
    IMAGE_NAME: vaultdrive # ✅ CORRECTED: It's "vaultdrive", not "vaultdrive-backend"
    VAULTDRIVE_RG: rg-vaultdrive
    CONTAINERAPPS_NAME: vaultdrive-backend
    ENV_RESOURCE_GROUP: rg-socialmedia
    ENVIRONMENT_NAME: managedEnvironment-rgsocialmedia-a2e6

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                      ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

            - name: Log in to Azure
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Get Environment ID
              id: get-env
              run: |
                  ENV_ID=$(az containerapp env show \
                    --name ${{ env.ENVIRONMENT_NAME }} \
                    --resource-group ${{ env.ENV_RESOURCE_GROUP }} \
                    --query id \
                    --output tsv)
                  echo "environment_id=$ENV_ID" >> $GITHUB_OUTPUT

            - name: Create or Update Container App
              run: |
                  # Check if container app exists
                  if az containerapp show \
                    --name ${{ env.CONTAINERAPPS_NAME }} \
                    --resource-group ${{ env.VAULTDRIVE_RG }} &> /dev/null; then
                    
                    echo "Updating existing container app..."
                    az containerapp update \
                      --name ${{ env.CONTAINERAPPS_NAME }} \
                      --resource-group ${{ env.VAULTDRIVE_RG }} \
                      --image ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  else
                    echo "Creating new container app..."
                    az containerapp create \
                      --name ${{ env.CONTAINERAPPS_NAME }} \
                      --resource-group ${{ env.VAULTDRIVE_RG }} \
                      --environment ${{ steps.get-env.outputs.environment_id }} \
                      --image ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                      --target-port 8080 \
                      --ingress external \
                      --min-replicas 0 \
                      --max-replicas 1 \
                      --cpu 0.25 \
                      --memory 0.5Gi \
                      --env-vars \
                        "PORT=8080" \
                        "DB_URL=${{ secrets.DB_URL }}" \
                        "JWT_SECRET=${{ secrets.JWT_SECRET }}"
                  fi

            - name: Get Backend URL
              run: |
                  BACKEND_URL=$(az containerapp show \
                    --name ${{ env.CONTAINERAPPS_NAME }} \
                    --resource-group ${{ env.VAULTDRIVE_RG }} \
                    --query properties.configuration.ingress.fqdn \
                    --output tsv)
                  echo "✅ Deployed to: https://$BACKEND_URL"
